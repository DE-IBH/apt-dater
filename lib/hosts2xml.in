#!/usr/bin/perl

use warnings;
use strict;

use Getopt::Std;
use Glib;
use XML::Writer;

$Getopt::Std::STANDARD_HELP_VERSION++;

sub HELP_MESSAGE {
    print <<USG;
Usage:

  convert_conf2xml <-(a|h)> [-i <fn>] [-o <fn>]

    -a		input is apt-dater.conf
    -h		input is hosts.conf
    -i          input filename
    -o          output filename

    --help      show this help
    --version   show version information

USG
}

sub VERSION_MESSAGE {
    print <<LIC;

apt-dater - terminal-based remote package update manager

Authors:
  Thomas Liske <liske\@ibh.de>

Copyright Holder:
  2008-2015 (C) IBH IT-Service GmbH [https://www.ibh.de/apt-dater/]

This program is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation; either version 2 of the License, or
(at your option) any later version.

LIC
#/
}

our $opt_a;
our $opt_h;
our $opt_i;
our $opt_o;
unless(getopts('ahi:o:')) {
    HELP_MESSAGE;
    exit 1;
}

die "Don't use -a and -h at the same time!\n"
    if($opt_a && $opt_h);


die "Missing option (-a or -h)!\n"
    unless($opt_a || $opt_h);

if($opt_a) {
    $opt_i = q(~/.config/apt-dater/apt-dater.conf) unless($opt_i);
    $opt_o = q(~/.config/apt-dater/apt-dater.xml) unless($opt_o);
}
else {
    $opt_i = q(~/.config/apt-dater/hosts.conf) unless($opt_i);
    $opt_o = q(~/.config/apt-dater/hosts.xml) unless($opt_o);
}

my %xparams = (
    DATA_MODE => 1,
    DATA_INDENT => 4,
    );

$xparams{OUTPUT} = IO::File->new(">$opt_o")
    if($opt_o);

my $xml = XML::Writer->new(%xparams);
$xml->doctype('apt-dater', undef, '@XMLSCHEMAURI@/apt-dater.dtd');
$xml->startTag('apt-dater', 'xmlns:xi' => q(http://www.w3.org/2001/XInclude));

$xml->comment('Include global config file if available.');
$xml->startTag('xi:include', href => q(file:///etc/apt-dater/apt-dater.xml), xpointer => q(xpointer(/apt-dater/*)));
$xml->emptyTag('xi:fallback');
$xml->endTag('xi:include');

$xml->endTag('apt-dater');
$xml->end();
$xparams{OUTPUT}->close();
